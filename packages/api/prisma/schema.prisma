generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                       String          @id @default(cuid())
  phone                    String          @unique
  name                     String
  email                    String?         @unique
  avatarUrl                String?
  googleId                 String?         @unique
  address                  String?
  verified                 Boolean         @default(false)
  role                     String          @default("CUSTOMER")
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt
  passwordHash             String?
  twoFactorEnabled         Boolean         @default(false)
  twoFactorSecret          String?
  backupCodes              String?
  emailVerified            Boolean         @default(false)
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  passwordResetToken       String?
  passwordResetExpires     DateTime?
  auditLogs                AdminAuditLog[]
  cart                     Cart?
  chatsAsFarmer            Chat[]          @relation("FarmerChats")
  chatsAsCustomer          Chat[]          @relation("CustomerChats")
  farmerChats              DirectChat[]    @relation("FarmerChats")
  customerChats            DirectChat[]    @relation("CustomerChats")
  sentMessages             DirectMessage[] @relation("SentMessages")
  events                   Event[]
  farmerProfile            FarmerProfile?
  messages                 Message[]
  orders                   Order[]
  productReviews           ProductReview[]
  products                 Product[]
  purchases                Purchase[]
  resolvedWarranties       WarrantyClaim[] @relation("ResolvedWarranties")
  warrantyClaims           WarrantyClaim[] @relation("CustomerWarranties")

  @@map("users")
}

model FarmerProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  businessName  String
  description   String?
  address       String?
  gstin         String?
  deliveryZones String?
  payoutAccount String?
  ratingAvg     Float    @default(0)
  totalSales    Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders        Order[]
  payouts       Payout[]

  @@map("farmer_profiles")
}

model Category {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?
  image       String?
  parentId    String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  @@map("categories")
}

model Product {
  id              String           @id @default(cuid())
  name            String
  description     String?
  price           Float
  unit            String
  minOrderQty     Int              @default(1)
  stockQty        Int              @default(0)
  stock           Int              @default(0)
  embedding       String?
  images          String?
  status          String           @default("DRAFT")
  featured        Boolean          @default(false)
  categoryId      String
  farmerId        String
  ratingAvg       Float            @default(0)
  ratingCount     Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  cartItems       CartItem[]
  directChats     DirectChat[]
  events          Event[]
  inventoryAlerts InventoryAlert[]
  orderItems      OrderItem[]
  reviews         ProductReview[]
  farmer          User             @relation(fields: [farmerId], references: [id], onDelete: Cascade)
  category        Category         @relation(fields: [categoryId], references: [id])
  purchases       Purchase[]

  @@map("products")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  items     CartItem[]
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("carts")
}

model CartItem {
  id                String   @id @default(cuid())
  cartId            String
  productId         String
  qty               Int
  unitPriceSnapshot Float
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  cart              Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@map("cart_items")
}

model Order {
  id              String          @id @default(cuid())
  orderNumber     String          @unique
  customerId      String
  farmerId        String
  total           Float
  status          String          @default("PLACED")
  paymentMethod   String
  addressSnapshot String
  deliverySlot    String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  chat            Chat?
  items           OrderItem[]
  farmer          FarmerProfile   @relation(fields: [farmerId], references: [id])
  customer        User            @relation(fields: [customerId], references: [id])
  payment         Payment?
  warrantyClaims  WarrantyClaim[]

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  qty       Int
  unitPrice Float
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model Payment {
  id        String   @id @default(cuid())
  orderId   String   @unique
  amount    Float
  status    String   @default("PENDING")
  paymentId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Payout {
  id        String        @id @default(cuid())
  farmerId  String
  amount    Float
  status    String        @default("DUE")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  farmer    FarmerProfile @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  @@map("payouts")
}

model Chat {
  id         String    @id @default(cuid())
  orderId    String    @unique
  customerId String
  farmerId   String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  farmer     User      @relation("FarmerChats", fields: [farmerId], references: [id])
  customer   User      @relation("CustomerChats", fields: [customerId], references: [id])
  order      Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  messages   Message[]

  @@map("chats")
}

model Message {
  id          String   @id @default(cuid())
  chatId      String
  senderId    String
  body        String
  attachments String?
  createdAt   DateTime @default(now())
  sender      User     @relation(fields: [senderId], references: [id])
  chat        Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Voucher {
  id           String    @id @default(cuid())
  code         String    @unique
  type         String
  value        Float
  minCartTotal Float?
  maxUses      Int?
  usedCount    Int       @default(0)
  expiresAt    DateTime?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("vouchers")
}

model AdminAuditLog {
  id        String   @id @default(cuid())
  adminId   String
  action    String
  before    String?
  after     String?
  createdAt DateTime @default(now())
  admin     User     @relation(fields: [adminId], references: [id])

  @@map("admin_audit_logs")
}

model DirectChat {
  id         String          @id @default(cuid())
  customerId String
  farmerId   String
  productId  String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  product    Product?        @relation(fields: [productId], references: [id])
  farmer     User            @relation("FarmerChats", fields: [farmerId], references: [id])
  customer   User            @relation("CustomerChats", fields: [customerId], references: [id])
  messages   DirectMessage[]

  @@unique([customerId, farmerId])
  @@map("direct_chats")
}

model DirectMessage {
  id        String     @id @default(cuid())
  chatId    String
  senderId  String
  body      String
  read      Boolean    @default(false)
  createdAt DateTime   @default(now())
  sender    User       @relation("SentMessages", fields: [senderId], references: [id])
  chat      DirectChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@map("direct_messages")
}

model Event {
  id        String   @id @default(cuid())
  userId    String?
  productId String?
  type      String
  value     Float?
  createdAt DateTime @default(now())
  meta      String?
  Product   Product? @relation(fields: [productId], references: [id])
  User      User?    @relation(fields: [userId], references: [id])

  @@map("events")
}

model Purchase {
  id          String   @id @default(cuid())
  userId      String
  productId   String
  quantity    Int
  totalAmount Float
  createdAt   DateTime @default(now())
  Product     Product  @relation(fields: [productId], references: [id])
  User        User     @relation(fields: [userId], references: [id])

  @@map("purchases")
}

model InventoryAlert {
  id        String   @id @default(cuid())
  productId String
  level     Int
  message   String
  createdAt DateTime @default(now())
  read      Boolean  @default(false)
  Product   Product  @relation(fields: [productId], references: [id])

  @@map("inventory_alerts")
}

model WarrantyClaim {
  id               String    @id @default(cuid())
  orderId          String
  customerId       String
  issueDescription String
  photos           String?
  requestDate      DateTime  @default(now())
  status           String    @default("PENDING")
  resolutionNotes  String?
  resolvedBy       String?
  resolvedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  resolver         User?     @relation("ResolvedWarranties", fields: [resolvedBy], references: [id])
  customer         User      @relation("CustomerWarranties", fields: [customerId], references: [id])
  order            Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("warranty_claims")
}

model ProductReview {
  id         String   @id @default(cuid())
  productId  String
  userId     String
  orderId    String?
  rating     Int
  comment    String?
  images     String?
  status     String   @default("APPROVED")
  mlAnalysis String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, userId])
  @@map("product_reviews")
}

model SupportMessage {
  id         String   @id @default(cuid())
  chatRoomId String
  senderId   String
  senderName String
  senderRole String
  body       String
  isAdmin    Boolean  @default(false)
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([chatRoomId])
  @@index([senderId])
  @@map("support_messages")
}

model FarmerRating {
  id        String   @id @default(cuid())
  farmerId  String
  userId    String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmerId, userId])
  @@map("farmer_ratings")
}
